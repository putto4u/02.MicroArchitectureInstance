

# Ubuntu VM을 활용한 파일 서버 구축 실무

## 1. 파일 서버 구축을 위한 사전 준비 (필수)

가상머신(VM)을 단순한 개인 연습용이 아닌 '서버'로 동작시키기 위해서는 네트워크 설정이 가장 중요하다.

### 1.1 VM 네트워크 모드 설정 (VirtualBox/VMware 공통)

파일 서버는 외부(호스트 PC 또는 같은 공유기를 쓰는 다른 PC)에서 접근 가능해야 한다.

* **NAT (기본값):** ❌ 비권장. VM이 외부와 격리되어 있어, 외부에서 VM으로 접속하려면 복잡한 포트 포워딩이 필요하다.
* **어댑터에 브리지 (Bridged Adapter):** ✅ **권장.** VM이 공유기로부터 공유기 대역(예: 192.168.0.x)의 독자적인 IP를 할당받는다. 호스트 PC와 동등한 네트워크 위치를 가지므로 서버 구축에 적합하다.

### 1.2 서버 업데이트 및 IP 확인

터미널을 열고 다음 명령어를 수행하여 패키지를 최신화하고 현재 IP를 확인한다.

```bash
sudo apt update && sudo apt upgrade -y
ip addr show
# (결과에서 inet 192.168.x.x 형태의 IP 주소를 메모해둔다.)

```

---

## 2. 시나리오 A: Samba (SMB) - 윈도우와 호환되는 표준 파일 서버

가장 범용적인 방식이다. 윈도우(Windows), 맥(Mac), 리눅스 모두에서 별도 프로그램 없이 폴더처럼 접근 가능하다.

### 2.1 설치

```bash
sudo apt install samba -y

```

### 2.2 공유 폴더 생성 및 권한 설정

공유할 실제 디렉터리를 만들고 권한을 부여한다.

```bash
# 홈 디렉터리에 share 폴더 생성
mkdir -p /home/$USER/share

# 누구든 읽고 쓸 수 있게 설정 (보안상 취약하나 실습용으로 권장)
chmod 777 /home/$USER/share

```

### 2.3 Samba 설정 파일 수정 (`/etc/samba/smb.conf`)

설정 파일을 열고 맨 아래에 다음 내용을 추가한다.

```bash
sudo nano /etc/samba/smb.conf

```

**[추가할 내용]**

```ini
[MyFileServer]
   path = /home/우분투사용자명/share
   writable = yes
   guest ok = no
   read only = no
   create mask = 0777
   directory mask = 0777
   valid users = 우분투사용자명

```

*(주의: `우분투사용자명` 부분을 실제 계정명으로 변경할 것)*

### 2.4 Samba 사용자 비밀번호 설정 (중요)

Samba는 리눅스 계정을 사용하지만, **비밀번호는 별도로 관리**한다.

```bash
sudo smbpasswd -a 우분투사용자명
# (사용할 비밀번호 입력)

```

### 2.5 서비스 재시작

```bash
sudo systemctl restart smbd

```

### 2.6 접속 테스트

* **Windows:** 실행(Win+R) → `\\VM_IP주소` 입력 (예: `\\192.168.0.50`)
* **Mac:** Finder → 이동 → 서버에 연결 → `smb://VM_IP주소`

---
본문 작성 전 확인 사항: 요청하신 대로 개인적인 대화나 설명은 생략하고, 강의 교재(책) 형식의 본문만 작성하였습니다.

---

# Samba 설정 분석: 단일 사용자 vs 다중 사용자 접근 제어

## 1. 설정 분석 결과

질문하신 설정 내용 중 `valid users` 항목에 단 하나의 계정명만 기입되어 있으므로, **현재 설정으로는 해당 유저 한 명만 접속이 가능하다.**

Samba는 1차적으로 `smb.conf` 설정을 통해 접근을 제어하고, 2차적으로 리눅스 파일 시스템 권한을 확인한다. 현재 설정은 1차 관문에서 다른 모든 사용자의 접근을 차단하고 있다.

### 주요 옵션 상세

* **valid users = 우분투사용자명:** '화이트리스트' 방식이다. 여기에 명시된 사용자(또는 그룹) 외에는 올바른 비밀번호를 입력해도 접속이 거부된다.
* **guest ok = no:** 익명 사용자(비밀번호 없는 접속)를 차단하므로, 반드시 `valid users`에 있는 계정으로 로그인해야 한다.

---

## 2. 다중 사용자 접속을 위한 설정 변경 방법

여러 명의 사용자가 이 공유 폴더를 함께 사용하게 하려면 `valid users` 항목을 수정해야 한다.

### 방법 A: 사용자 ID 나열 (소규모 환경)

사용자 ID를 공백(Space)으로 구분하여 나열한다.

```ini
valid users = user1 user2 user3

```

### 방법 B: 리눅스 그룹 사용 (권장)

리눅스 그룹을 생성하고 해당 그룹에 속한 모든 멤버를 허용하는 방식이다. 관리가 훨씬 용이하다. 그룹명 앞에 `@` 또는 `+`를 붙인다.

```ini
valid users = @sharegroup

```

---

## 3. 주의사항: 홈 디렉터리 경로와 리눅스 권한 충돌

현재 설정에서 **가장 주의해야 할 점**은 공유 경로(`path`)의 위치이다.

```ini
path = /home/우분투사용자명/share

```

설령 `valid users = user1 user2`로 설정을 변경하여 Samba가 `user2`의 접속을 허용하더라도, **실제 파일 접근은 실패할 가능성이 매우 높다.** 그 이유는 **리눅스 파일 시스템 권한(OS 레벨)** 때문이다.

### 왜 접속이 안 되는가?

1. **Samba 레벨:** `valid users`에 `user2`가 있으므로 통과.
2. **OS 레벨:** `user2`가 `/home/user1/share`에 접근 시도.
3. **권한 거부:** 리눅스의 기본 설정상 `/home/user1` 디렉터리는 소유자(`user1`)만 접근 가능(rwx------)하게 설정되어 있다. 따라서 `user2`는 폴더 진입 자체가 불가능하다.

### 해결책: 공유 전용 디렉터리 사용

다중 사용자가 공유해야 한다면, 개인 홈 디렉터리가 아닌 별도의 **공용 경로**를 사용하는 것이 표준이다.

**1. 디렉터리 생성 및 권한 설정 (터미널)**

```bash
# 1. 공용 디렉터리 생성 (예: /srv/samba/share)
sudo mkdir -p /srv/samba/share

# 2. 공유 그룹 생성
sudo groupadd smbgroup

# 3. 사용자들을 그룹에 추가
sudo usermod -aG smbgroup user1
sudo usermod -aG smbgroup user2

# 4. 디렉터리 소유권 변경 (root:smbgroup)
sudo chown root:smbgroup /srv/samba/share

# 5. 디렉터리 권한 설정 (그룹 멤버 쓰기 허용, SGID 설정)
sudo chmod 2770 /srv/samba/share

```

**2. smb.conf 수정**

```ini
[TeamShare]
   path = /srv/samba/share
   writable = yes
   browsable = yes
   guest ok = no
   valid users = @smbgroup
   create mask = 0770
   directory mask = 0770

```

* `chmod 2770`과 `mask 0770`: 그룹 멤버끼리는 자유롭게 읽고 쓰기가 가능하지만, 외부인은 접근할 수 없도록 설정한다.

---
## Samba (SMB) 파일 서버 구축 및 다중 사용자 권한 관리

Samba는 리눅스와 윈도우 환경 간의 파일 공유를 가능하게 하는 표준 프로토콜입니다. 본 가이드에서는 CLI를 통한 수동 설정 방식과 Terraform을 이용한 코드 기반의 자동화 인프라 구축 방식을 정의합니다.

---

### 1. CLI 기반 Samba 구축 및 공용 디렉터리 설정

터미널에서 실행되는 각 명령어는 패키지 설치부터 다중 사용자 접근을 위한 권한 설계 단계를 포함합니다.

```bash
# 1. 패키지 관리자를 통해 Samba 서비스 설치
sudo apt update && sudo apt install samba -y            # 패키지 목록 동기화 및 Samba 패키지 무인 설치

# 2. 공용 데이터 저장소 생성
sudo mkdir -p /srv/samba/share                          # 사용자 홈 디렉터리 외부의 독립된 공유 경로 생성

# 3. 사용자 그룹 관리
sudo groupadd smbgroup                                  # 공유 폴더에 접근할 사용자들을 묶을 전용 그룹 생성
sudo usermod -aG smbgroup $USER                         # 현재 접속 계정을 해당 그룹에 멤버로 등록

# 4. 파일 시스템 권한 및 상속 설정 (SGID)
sudo chown root:smbgroup /srv/samba/share               # 관리자는 root, 그룹 소유권은 smbgroup으로 지정
sudo chmod 2770 /srv/samba/share                        # 그룹 멤버 권한 부여 및 생성 파일의 그룹 소유권 상속 설정

# 5. 서비스 계정 인증 설정
sudo smbpasswd -a $USER                                 # OS 계정과는 별개로 Samba 전용 접속 비밀번호 등록

# 6. 설정 파일 반영 (설정 하단에 공유 규칙 추가)
sudo cat <<EOT >> /etc/samba/smb.conf                   # 설정 파일 끝에 아래의 구문을 직접 삽입

[TeamShare]                                             # 네트워크 브라우저에서 표시될 공유 자원의 식별자
   path = /srv/samba/share                              # 서버 내부의 실제 저장소 물리적 위치
   writable = yes                                       # 허용된 사용자의 데이터 수정 및 쓰기 허용
   guest ok = no                                        # 익명 사용자의 접근을 차단하고 인증 사용자만 허용
   valid users = @smbgroup                              # smbgroup 그룹에 소속된 인원만 접속 허용
   create mask = 0770                                   # 신규 파일 생성 시 소유자와 그룹원만 접근 가능토록 설정
   directory mask = 0770                                # 신규 폴더 생성 시 소유자와 그룹원만 접근 가능토록 설정
EOT                                                     # 입력 종료

# 7. 구성 적용 및 서비스 구동
sudo systemctl restart smbd                             # 수정된 설정값 적용을 위해 서비스 프로세스 재시작
sudo systemctl enable smbd                              # 시스템 재부팅 시 서비스가 자동으로 시작되도록 등록

```

---

## 인프라 프로비저닝과 구성 관리의 결합: Terraform & Ansible

운영 환경에서는 인프라의 '뼈대'를 만드는 **Terraform**과 서버 내부의 '서비스 설정'을 담당하는 **Ansible**을 순차적으로 사용하는 것이 표준입니다. 서버를 재생성하지 않고 설정만 변경할 수 있는 안정적인 작업 순서를 정의합니다.

---

### 1. 작업 단계 정의

1. **Terraform**: 클라우드 인프라(VPC, EC2, 보안 그룹)를 생성하고 인스턴스의 IP 주소를 확보합니다.
2. **Inventory 구성**: Terraform이 생성한 IP를 Ansible이 접속할 대상 리스트에 등록합니다.
3. **Ansible**: 확보된 IP로 원격 접속하여 Samba 패키지 설치 및 다중 사용자 환경을 설정합니다.

---

### 2. 단계 1: Terraform을 이용한 인프라 구축

인스턴스 생성 및 SMB 통신을 위한 네트워크 포트를 개방합니다.

**파일명: `infra_setup.tf**`

```hcl
# AWS 프로바이더 설정
provider "aws" {
  region = "ap-northeast-2"                              # 서비스 지역을 서울 리전으로 지정
}

# 보안 그룹 정의 (SMB 포트 445 개방)
resource "aws_security_group" "samba_sg" {
  name        = "samba-access-sg"                         # 보안 그룹의 식별 이름
  description = "Allow SMB traffic"                       # 보안 그룹에 대한 설명

  ingress {
    from_port   = 445                                     # SMB 표준 포트 번호 시작
    to_port     = 445                                     # SMB 표준 포트 번호 종료
    protocol    = "tcp"                                   # TCP 프로토콜 사용
    cidr_blocks = ["192.168.1.0/24"]                      # 허용할 특정 네트워크 대역 지정
  }

  egress {
    from_port   = 0                                       # 모든 나가는 포트 허용 시작
    to_port     = 0                                       # 모든 나가는 포트 허용 종료
    protocol    = "-1"                                    # 모든 프로토콜 허용
    cidr_blocks = ["0.0.0.0/0"]                           # 모든 목적지 허용
  }
}

# Samba 구동용 EC2 인스턴스 생성
resource "aws_instance" "samba_host" {
  ami           = "ami-0c9c942bd7bf113a2"                 # Ubuntu 22.04 LTS 이미지 ID
  instance_type = "t3.micro"                              # 인스턴스 사양 (실습용 저사양 지정)
  vpc_security_group_ids = [aws_security_group.samba_sg.id] # 생성한 보안 그룹 연결

  tags = {
    Name = "Samba-Target-Server"                          # 인스턴스 태그 명칭 지정
  }
}

# 생성된 인스턴스의 공인 IP 출력 (Ansible 연동용)
output "samba_server_ip" {
  value = aws_instance.samba_host.public_ip               # 생성 완료 후 화면에 IP 표시
}

```

---

### 3. 단계 2: Ansible을 이용한 서비스 구성 관리

서버 내부 설정을 담당하는 코드를 작성합니다. 서버를 삭제하지 않고 이 파일만 수정하여 다시 실행하면 설정이 업데이트됩니다.

**파일명: `samba_config.yml` (Ansible Playbook)**

```yaml
- name: Setup Multi-User Samba Server                     # 플레이북 작업의 명칭
  hosts: samba_servers                                    # 인벤토리에 정의된 대상 그룹명
  become: yes                                             # 관리자(root) 권한으로 명령 실행
  
  tasks:
    - name: Install Samba Package                         # 1. 패키지 설치 단계
      apt:                                                # 우분투 패키지 모듈 사용
        name: samba                                       # 설치할 패키지명
        state: present                                    # 설치된 상태 유지
        update_cache: yes                                 # 패키지 인덱스 업데이트 병행

    - name: Create Samba Shared Group                     # 2. 전용 그룹 생성 단계
      group:                                              # 그룹 관리 모듈 사용
        name: smbgroup                                    # 생성할 그룹명
        state: present                                    # 그룹 존재 상태 보장

    - name: Create Shared Directory                       # 3. 공용 폴더 생성 단계
      file:                                               # 파일/디렉터리 관리 모듈 사용
        path: /srv/samba/share                            # 생성할 경로 지정
        state: directory                                  # 디렉터리 형식으로 생성
        owner: root                                       # 소유자 설정
        group: smbgroup                                   # 그룹 소유권 설정
        mode: '2770'                                      # SGID 및 그룹 접근 권한 설정

    - name: Configure smb.conf File                       # 4. 설정 파일 구성 단계
      blockinfile:                                        # 파일 내 텍스트 블록 삽입 모듈
        path: /etc/samba/smb.conf                         # 대상 설정 파일 경로
        block: |                                          # 삽입할 실제 설정 내용
          [TeamShare]
             path = /srv/samba/share
             writable = yes
             guest ok = no
             valid users = @smbgroup
             create mask = 0770
             directory mask = 0770
        marker: "# {mark} ANSIBLE MANAGED BLOCK #"       # 중복 삽입 방지용 마커 주석
      notify: Restart Samba                               # 내용 변경 시 핸들러(재시작) 호출

  handlers:                                               # 트리거 발생 시 실행될 작업
    - name: Restart Samba                                 # 서비스 재시작 핸들러
      service:                                            # 서비스 관리 모듈 사용
        name: smbd                                        # 대상 서비스명
        state: restarted                                  # 서비스 재시작 수행

```

---

### 4. 전체 실행 순서 및 명령어

1. **인프라 생성 (Terraform)**
```bash
terraform init                                        # 테라폼 초기화 및 프로바이더 다운로드
terraform apply -auto-approve                         # 인프라 생성 승인 및 실행

```


2. **접속 대상 등록 (Inventory)**
* `hosts` 파일을 생성하여 Terraform 출력 결과인 IP 주소를 기입합니다.


```ini
[samba_servers]
13.125.xx.xx  ansible_user=ubuntu                    # 테라폼에서 확인한 IP 주소 입력

```


3. **서비스 설정 적용 (Ansible)**
```bash
ansible-playbook -i hosts samba_config.yml            # 생성된 서버에 접속하여 삼바 설정 자동 수행

```



---

### 5. 과금 및 운영 관리 지침

* **테라폼 재실행 주의**: `infra_setup.tf`에서 인스턴스 타입이나 AMI를 수정하고 `apply`하면 기존 서버가 삭제되고 새 서버가 만들어지며 요금이 중복 발생할 수 있습니다.
* **앤서블의 안정성**: `samba_config.yml`에서 설정값만 수정하여 실행할 경우, 서버는 삭제되지 않으며 인스턴스 비용도 추가되지 않고 설정만 안전하게 변경됩니다.
* **네트워크 과금**: 인벤토리를 통해 외부 IP로 접속할 경우 미세한 데이터 전송 비용이 발생할 수 있습니다.

Next Step: Ansible Vault를 이용한 비밀번호 암호화 관리

---

Samba 인프라 구축과 서비스 설정을 Terraform과 Ansible로 분리하여 구성하였습니다. 인프라의 뼈대는 테라폼으로 고정하고, 변경이 잦은 서비스 설정은 앤서블로 관리하는 것이 운영 안정성과 비용 효율 측면에서 가장 적절합니다.

Next Step: Ansible Vault 관리 및 실습

## 3. 시나리오 B: NFS (Network File System) - 리눅스 간 고속 공유

클라이언트가 리눅스(다른 VM, 라즈베리파이 등)인 경우 오버헤드가 적고 속도가 빠른 NFS를 사용한다.

### 3.1 설치

```bash
sudo apt install nfs-kernel-server -y

```

### 3.2 공유 설정 (`/etc/exports`)

NFS는 설정 파일에 '누구에게 공유할지'를 명시해야 한다.

```bash
sudo nano /etc/exports

```

**[추가할 내용]**

```text
/home/우분투사용자명/share  *(rw,sync,no_root_squash,no_subtree_check)

```

* `*`: 모든 IP 허용 (보안을 위해 `192.168.0.10(rw)` 처럼 특정 IP 지정 권장)
* `rw`: 읽기/쓰기 허용
* `sync`: 데이터 변경 사항을 즉시 디스크에 기록 (안정성)

### 3.3 적용 및 서비스 시작

```bash
sudo exportfs -a
sudo systemctl restart nfs-kernel-server

```

### 3.4 클라이언트(다른 리눅스)에서 마운트

```bash
# 클라이언트 PC에서
sudo mount -t nfs [서버IP]:/home/우분투사용자명/share /mnt/my_mount_point

```

---

## 4. 시나리오 C: SFTP (SSH) - 별도 설치 없는 간편 전송

SSH(Secure Shell)가 설치되어 있다면 SFTP도 이미 작동 중이다. 가장 보안성이 높고 설정이 필요 없다.

* **준비물:** SSH 서버 설치 (`sudo apt install openssh-server`)
* **접속 도구:** FileZilla, WinSCP (Windows), CyberDuck (Mac)
* **접속 방법:**
* 프로토콜: SFTP
* 호스트: VM IP 주소
* 사용자/비번: 우분투 계정 정보 그대로 사용



---

## 5. 프로토콜별 비교 및 선택 가이드

| 프로토콜 | Samba (SMB) | NFS | SFTP |
| --- | --- | --- | --- |
| **주 호환성** | **Windows**, Mac, Linux | **Linux**, Unix | 모든 OS (전용 클라이언트 필요) |
| **성능** | 보통 (오버헤드 존재) | **빠름** (커널 레벨 동작) | 보통 (암호화 부하 존재) |
| **편의성** | 높음 (네트워크 드라이브로 잡힘) | 보통 (마운트 명령 필요) | 낮음 (전용 프로그램 필요) |
| **주 용도** | 사내/가정용 파일 공유, 협업 | 서버 간 데이터 공유, 클러스터링 | 원격지 파일 전송, 보안 전송 |

---

## 6. 방화벽(UFW) 설정 주의사항

연결이 안 된다면 우분투 방화벽이 포트를 막고 있을 확률이 높다. 필요한 포트만 열어준다.

```bash
# 방화벽 상태 확인
sudo ufw status

# Samba 포트 허용
sudo ufw allow samba

# NFS 포트 허용 (NFS는 포트가 유동적이므로 로컬 대역 전체 허용 권장)
sudo ufw allow from 192.168.0.0/24 to any port nfs

# SSH(SFTP) 허용
sudo ufw allow ssh

# 방화벽 활성화
sudo ufw enable

```

---

Next Step: Linux Permissions (chmod, chown, chgrp) & ACL Detailed Guide
