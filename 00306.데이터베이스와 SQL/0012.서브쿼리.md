# Chapter 7-1. 서브쿼리(Subquery)의 개념과 기본 유형

서브쿼리(Subquery)는 **"하나의 SQL 문장 안에 포함된 또 다른 SQL 문장"**을 의미합니다. 마치 마트료시카 인형처럼, 쿼리 내부에 또 다른 쿼리가 숨어 있는 구조입니다.

가장 중요한 개념은 **"실행 순서"**입니다. 일반적으로 내부에 있는 서브쿼리가 먼저 실행되어 그 결과를 반환하면, 바깥에 있는 메인 쿼리(Main Query)가 그 값을 받아 최종 결과를 수행합니다.

---

### 1. 서브쿼리가 필요한 이유: '2단계'를 '1단계'로

서브쿼리를 사용하면 두 번 쿼리를 날려야 할 작업을 한 번에 끝낼 수 있습니다.

#### 상황: "직원 '홍길동'보다 연봉을 많이 받는 사람은 누구인가?"

이 질문에 답하려면 우리는 논리적으로 두 가지 정보를 알아야 합니다.

1. **Step 1:** 홍길동의 연봉이 얼마인지 알아낸다. (예: 5,000만 원)
2. **Step 2:** 연봉이 5,000만 원보다 높은 사람을 검색한다.

#### 1.1 서브쿼리 미사용 (2번 실행)

```sql
-- 1. 먼저 홍길동의 연봉을 조회 (결과: 5000 확인)
SELECT salary FROM employees WHERE name = '홍길동';

-- 2. 확인한 값을 손으로 입력하여 재조회
SELECT name FROM employees WHERE salary > 5000;

```

#### 1.2 서브쿼리 사용 (1번 실행)

괄호 `()` 안에 있는 쿼리가 먼저 실행되어 `5000`이라는 값을 구해오고, 메인 쿼리는 `> 5000` 조건으로 동작합니다.

```sql
SELECT name
FROM employees
WHERE salary > (SELECT salary FROM employees WHERE name = '홍길동');

```

---

### 2. 서브쿼리의 반환 값에 따른 분류

서브쿼리가 뱉어내는 결과의 **형태(모양)**에 따라 사용할 수 있는 연산자가 달라집니다. 이 부분을 틀리면 가장 많은 에러가 발생합니다.

#### 2.1 단일행 서브쿼리 (Single-Row Subquery)

* **특징:** 서브쿼리의 실행 결과가 **정확히 값 1개**(1행 1열)만 나옵니다.
* **사용 연산자:** 단일 값 비교 연산자 (`=`, `>`, `<`, `>=`, `<=`, `<>`)
* **예시:** "전체 사원의 **평균** 급여보다 많이 받는 사람" (평균값은 딱 하나뿐임)

```sql
SELECT name, salary
FROM employees
WHERE salary > (SELECT AVG(salary) FROM employees); -- 결과값: 4500 (1개)

```

#### 2.2 다중행 서브쿼리 (Multi-Row Subquery)

* **특징:** 서브쿼리의 실행 결과가 **여러 개의 행(Row)**으로 나옵니다.
* **사용 연산자:** 다중 값 연산자 (`IN`, `ANY`, `ALL`, `EXISTS`)
* **주의:** 결과가 여러 개인데 `=` (등호)를 쓰면 에러가 납니다. (100, 200, 300과 같다? 논리적 모순)
* **예시:** "'IT' 부서나 'Sales' 부서에 속한 모든 직원" (부서 ID가 여러 개 나옴)

```sql
-- 에러 발생 쿼리 (서브쿼리 결과가 여러 개임)
SELECT name FROM employees WHERE dept_id = (SELECT dept_id FROM departments WHERE location = 'Seoul');

-- 올바른 쿼리 (IN 사용)
SELECT name
FROM employees
WHERE dept_id IN (SELECT dept_id FROM departments WHERE location = 'Seoul');

```

---

### 3. 다중행 서브쿼리 핵심 연산자

다중행 서브쿼리에서 사용하는 연산자는 의미를 정확히 파악해야 합니다.

| 연산자 | 의미 | 예시 설명 |
| --- | --- | --- |
| **IN** | 결과값 중 **하나라도 일치**하면 참 (OR 조건) | 리스트에 있는 값 중 아무거나 하나랑 같으면 통과. |
| **ANY** | 결과값 중 **하나라도 조건에 맞으면** 참 | `> ANY (...)`: 목록 중 **최솟값**보다 크면 참. (누구든 한 명만 이기면 됨) |
| **ALL** | 결과값 **모두와 조건이 맞아야** 참 | `> ALL (...)`: 목록 중 **최댓값**보다 커야 참. (전원을 다 이겨야 됨) |

### 4. 서브쿼리의 위치에 따른 명칭

서브쿼리는 SQL 문장 어디에 들어가느냐에 따라 부르는 이름과 역할이 다릅니다.

1. **WHERE 절:** **중첩 서브쿼리 (Nested Subquery)**
* 일반적인 서브쿼리. 데이터를 필터링하기 위한 조건값으로 사용됩니다.


2. **FROM 절:** **인라인 뷰 (Inline View)**
* 가상의 테이블처럼 사용합니다. 뷰(View)처럼 동작하며, 쿼리 실행 중에만 임시로 생성되었다가 사라집니다.


3. **SELECT 절:** **스칼라 서브쿼리 (Scalar Subquery)**
* 마치 컬럼처럼 사용됩니다. 결과는 반드시 1행 1열(단일 값)이어야 합니다.



Next Step: FROM절에 사용하는 인라인 뷰(Inline View)와 SELECT절의 스칼라 서브쿼리 실습
