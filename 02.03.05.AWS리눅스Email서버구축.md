AWS Ubuntu Linux 서버에 이메일 서버를 구축하는 방법은 \*\*보안(Security)\*\*과 **운영(Operation)** 측면에서 고려할 점이 많지만, **Postfix (MTA)**, **Dovecot (IMAP/POP3)**, 그리고 \*\*Roundcube (Webmail)\*\*을 중심으로 실전 가이드를 구성해 드리겠습니다.


-----

# 📧 AWS Ubuntu 서버에 이메일 서버 구축 가이드 (Postfix, Dovecot, Roundcube)

## 🎯 개요

이 가이드는 AWS EC2 인스턴스(Ubuntu 22.04 LTS 기준)를 활용하여 자체 이메일 서버를 구축하고 운영하는 방법을 설명합니다.

| 서비스 | 역할 |
| :--- | :--- |
| **Postfix** | 메일 전송 에이전트 (MTA, Mail Transfer Agent) |
| **Dovecot** | 메일 접근 에이전트 (MDA, Mail Delivery Agent, IMAP/POP3) |
| **Roundcube** | 웹 기반 이메일 클라이언트 (Webmail) |

-----

## 1\. 전제 조건 및 준비 사항 (중요\!)

### 1.1. EC2 인스턴스 준비

  * **OS:** Ubuntu 22.04 LTS (최신 버전 권장)
  * **Elastic IP (EIP):** 필수\! 서버의 IP 주소가 변경되면 메일 전송/수신에 치명적인 문제가 발생합니다.
  * **호스트네임 설정:** 서버의 호스트네임을 도메인(예: `mail.example.com`)으로 설정해야 합니다.
    ```bash
    sudo hostnamectl set-hostname mail.yourdomain.com
    ```

### 1.2. 도메인 및 DNS 설정 (AWS Route 53 또는 외부 DNS)

이메일 서버 운영의 **가장 중요한 부분**입니다. 도메인의 DNS 레코드를 정확하게 설정해야 스팸으로 분류되는 것을 방지할 수 있습니다.

| 레코드 유형 | 호스트 | 값 (Value) | 목적 |
| :--- | :--- | :--- | :--- |
| **A** | `mail` | **EC2의 EIP 주소** | 메일 서버의 IP 주소 지정 |
| **MX** | `@` 또는 `yourdomain.com` | `10 mail.yourdomain.com` | 메일 수신 서버 지정 (숫자는 우선순위) |
| **PTR (Reverse DNS)** | (AWS 문의 필요) | `mail.yourdomain.com` | **⭐ 필수 보안 설정\!** IP 주소로 도메인을 찾는 역방향 조회. AWS에 **EIP에 대한 PTR 레코드** 설정을 요청해야 합니다. |
| **SPF** | `@` | `v=spf1 mx a ip4:[EIP] ~all` | **스팸 방지(보안)\!** 이 도메인에서 메일을 보낼 수 있는 IP를 명시 |
| **DKIM** | (랜덤 텍스트) | (긴 키 값) | **스팸 방지(보안)\!** 메일 변조 방지 (나중에 설정) |

### 1.3. 보안 그룹 (Security Group) 설정

다음 포트를 인바운드 규칙에 허용해야 합니다.

| 포트 | 프로토콜 | 설명 | 실전 팁 |
| :--- | :--- | :--- | :--- |
| **25** | TCP | **SMTP** (메일 전송) | **AWS 제한 가능성:** AWS는 25번 포트를 기본적으로 차단합니다. **반드시 AWS에 25번 포트 제한 해제를 요청해야 합니다.** |
| **110** | TCP | **POP3** (메일 다운로드) | |
| **143** | TCP | **IMAP** (메일 동기화) | |
| **993** | TCP | **IMAPS** (보안 IMAP) | **TLS/SSL 설정 시 권장** |
| **995** | TCP | **POP3S** (보안 POP3) | **TLS/SSL 설정 시 권장** |
| **465** | TCP | **SMTPS** (보안 SMTP) | **TLS/SSL 설정 시 권장** |
| **587** | TCP | **Submission** (클라이언트 메일 발송) | **권장 포트** |
| **80, 443** | TCP | **HTTP/HTTPS** (웹메일 접근용) | |

-----

## 2\. Postfix (MTA) 설치 및 설정

### 2.1. 설치

```bash
sudo apt update
sudo apt install postfix -y
# 설치 시, "Internet Site"를 선택하고 FQDN을 입력합니다. (예: mail.yourdomain.com)
```

### 2.2. 기본 설정 (`/etc/postfix/main.cf`)

```bash
sudo vi /etc/postfix/main.cf
```

**[수정할 주요 설정]**

| 설정 항목 | 예시 값 | 설명 |
| :--- | :--- | :--- |
| `myhostname` | `mail.yourdomain.com` | 이 서버의 정식 호스트 이름 |
| `mydomain` | `yourdomain.com` | 이메일 도메인 |
| `myorigin` | `/etc/mailname` | 발신 도메인 설정 파일 |
| `mydestination` | `$myhostname, $mydomain, localhost.$mydomain, localhost` | 메일을 수신할 도메인 목록 |
| `mynetworks` | `127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 [VPC CIDR]` | 릴레이 허용 네트워크 (VPC 내부망 IP 포함이 실전 팁) |
| `inet_interfaces` | `all` | 모든 네트워크 인터페이스에서 수신 |

### 2.3. 서비스 재시작

```bash
sudo systemctl restart postfix
sudo systemctl enable postfix
```

-----

## 3\. Dovecot (IMAP/POP3) 설치 및 설정

Dovecot은 메일함에 접근할 수 있는 프로토콜을 제공합니다.

### 3.1. 설치

```bash
sudo apt install dovecot-imapd dovecot-pop3d -y
```

### 3.2. 설정 파일 수정

사용자가 접속할 때 `mail` 디렉토리를 사용하도록 설정합니다.

```bash
sudo vi /etc/dovecot/conf.d/10-mail.conf
```

  * `mail_location = maildir:~/Maildir` (주석 해제 또는 추가)

인증 설정을 허용합니다.

```bash
sudo vi /etc/dovecot/conf.d/10-auth.conf
```

  * `disable_plaintext_auth = yes` → `disable_plaintext_auth = no` (테스트 시, 보안을 위해 운영 시 **TLS/SSL 적용 필수**)
  * `auth_mechanisms = plain login` (추가)

### 3.3. Postfix 연동 설정

Postfix가 Dovecot의 인증 메커니즘을 사용하도록 연동합니다.

```bash
sudo vi /etc/dovecot/conf.d/10-master.conf
```

  * `service auth` 섹션 아래의 `unix_listener /var/spool/postfix/private/auth` 부분을 찾아서 주석 해제합니다.
    ```text
    # /etc/dovecot/conf.d/10-master.conf 내용 중
    service auth {
      # Postfix LDA/SMTP-AUTH uses this.
      unix_listener /var/spool/postfix/private/auth {
        mode = 0660
        user = postfix
        group = postfix
      }
      # ...
    }
    ```

### 3.4. 서비스 재시작

```bash
sudo systemctl restart dovecot
sudo systemctl enable dovecot
sudo systemctl restart postfix # Postfix도 연동 변경을 위해 재시작
```

-----

## 4\. 사용자 생성 및 메일 테스트

### 4.1. 메일 계정으로 사용할 시스템 사용자 생성

```bash
sudo adduser newuser
# 이 사용자의 이메일 주소는 newuser@yourdomain.com 이 됩니다.
```

### 4.2. 메일 테스트 (CLI)

내부에서 메일 전송 테스트를 합니다.

```bash
# 새로운 사용자 newuser로 전환
su - newuser

# testuser에게 메일 전송
echo "Test mail body" | mail -s "Test Subject" newuser@yourdomain.com
```

메일이 도착했는지 `/var/mail/newuser` 또는 `~/Maildir` 경로에서 확인합니다.

-----

## 5\. Roundcube (Webmail) 설치 및 설정

사용자가 웹 브라우저로 접속할 수 있도록 웹메일 인터페이스를 제공합니다.

### 5.1. LAMP 환경 구축 (Apache, PHP, MySQL)

Roundcube는 PHP 기반이므로 Apache와 PHP 환경이 필요합니다.

```bash
sudo apt install apache2 php libapache2-mod-php php-mysql php-imap php-mbstring php-intl php-json php-curl php-gd -y
```

### 5.2. Roundcube 설치 및 설정

최신 Roundcube 패키지를 다운로드하고 웹 서버 경로에 설치합니다. (버전 확인 후 설치)

```bash
wget https://github.com/roundcube/roundcubemail/releases/download/1.6.4/roundcubemail-1.6.4-complete.tar.gz # 최신 버전 확인 후 변경
tar -xf roundcubemail-1.6.4-complete.tar.gz
sudo mv roundcubemail-1.6.4 /var/www/html/webmail

# 권한 설정
sudo chown -R www-data:www-data /var/www/html/webmail
```

웹 설치 마법사를 통해 데이터베이스를 설정하고 Postfix/Dovecot 연결 정보를 입력합니다. (브라우저에서 `http://mail.yourdomain.com/webmail/installer` 접속)

-----

## ⚠️ 실전 팁 및 자주 오해하거나 실수하는 부분 (보안, IP)

1.  **스팸 이슈 (가장 중요\!):** 자체 메일 서버의 메일이 스팸으로 분류될 가능성이 매우 높습니다. 이를 방지하기 위해 **PTR, SPF, DKIM** 레코드를 **반드시** 완벽하게 설정해야 합니다. 특히 AWS에서 PTR 레코드는 고객이 직접 설정할 수 없고 AWS Support를 통해 요청해야 합니다.
2.  **보안 강화 (TLS/SSL):** 모든 IMAP, POP3, SMTP 서비스는 \*\*TLS/SSL (Let's Encrypt 등)\*\*을 적용하여 \*\*보안 포트(465, 587, 993, 995)\*\*로만 접속을 허용해야 합니다. 평문 인증은 절대 사용하지 마세요.
3.  **AWS 25번 포트:** 다시 강조하지만, AWS는 악용 방지를 위해 25번 포트를 기본적으로 막습니다. **반드시 Support Ticket을 열어 해제 요청을 진행해야 합니다.**

-----

**출처:** Postfix 공식 문서, Dovecot Wiki, Roundcube Documentation, AWS EC2 네트워킹 가이드

