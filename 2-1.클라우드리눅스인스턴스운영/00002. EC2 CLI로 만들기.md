# AWS CLI를 활용한 EC2 웹 서버 자동 구축 실습 (Lab Guide)

이 장에서는 관리 콘솔(GUI)이 아닌 AWS CLI(Command Line Interface)를 사용하여 인프라를 코드로 제어하는 방법을 학습합니다. 이는 **IaC(Infrastructure as Code)**의 기초가 되며, 자동화된 배포의 핵심 과정입니다.

> **※ 과금 주의:** 본 실습은 **Free Tier** (`t2.micro` 등)를 기준으로 작성되었으나, 실습 완료 후 리소스를 삭제하지 않으면 **EBS 스토리지** 및 **퍼블릭 IP** 요금이 발생할 수 있습니다.

---

### 1. 사전 준비 및 환경 설정

CLI 명령어를 실행하기 전, 이전 챕터에서 설치한 AWS CLI가 정상적으로 인증되어 있는지 확인합니다.

```bash
# 인증 정보 확인 (Account ID와 IAM ARN이 출력되어야 함)
aws sts get-caller-identity

```

---

### 2. 네트워크 및 보안 그룹 구성

서버가 위치할 방화벽(보안 그룹)을 생성하고, SSH(22)와 HTTP(80) 포트를 개방합니다.

#### 2.1 보안 그룹 생성

```bash
# 보안 그룹 생성 (출력된 GroupId를 기록해 두세요. 예: sg-0123456789abcdef0)
aws ec2 create-security-group \
    --group-name Web-Server-SG-CLI \
    --description "Security group for CLI lab"

```

#### 2.2 인바운드 규칙(포트) 추가

위에서 생성한 보안 그룹 ID(`sg-xxxx`)를 사용하여 규칙을 추가합니다.

```bash
# 1. SSH (22번 포트) 개방 - 내 IP만 허용 권장 (여기서는 편의상 전체 허용)
aws ec2 authorize-security-group-ingress \
    --group-id sg-[본인의_보안그룹ID] \
    --protocol tcp --port 22 --cidr 0.0.0.0/0

# 2. HTTP (80번 포트) 개방 - 웹 서버용 전체 허용
aws ec2 authorize-security-group-ingress \
    --group-id sg-[본인의_보안그룹ID] \
    --protocol tcp --port 80 --cidr 0.0.0.0/0

```

---

### 3. 키 페어 생성 및 저장

SSH 접속을 위한 프라이빗 키를 생성하고 파일로 저장합니다. OS별로 파일 저장 명령어가 다릅니다.

**[Linux / Mac]**

```bash
# 키 생성 및 .pem 파일로 저장 (권한 설정 포함)
aws ec2 create-key-pair \
    --key-name my-cli-key \
    --query 'KeyMaterial' \
    --output text > my-cli-key.pem

chmod 400 my-cli-key.pem

```

**[Windows PowerShell]**

```powershell
# 키 생성 및 파일 저장
aws ec2 create-key-pair `
    --key-name my-cli-key `
    --query 'KeyMaterial' `
    --output text | Out-File -Encoding ascii -FilePath my-cli-key.pem

```

---

### 4. 사용자 데이터(User Data) 스크립트 파일 작성

Nginx를 자동으로 설치하는 스크립트 파일을 로컬에 생성합니다.

**파일명:** `user_data.sh`

```bash
#!/bin/bash
dnf update -y
dnf install nginx -y
systemctl start nginx
systemctl enable nginx
echo "<h1>Hello! AWS CLI Web Server</h1>" > /usr/share/nginx/html/index.html

```

* **Linux:** `vi user_data.sh` 또는 `nano user_data.sh`로 작성.
* **Windows:** 메모장을 열어 작성 후 `user_data.sh`로 저장 (확장자 주의).

---

### 5. 최신 AMI ID 조회 (Amazon Linux 2023)

리전별로 OS 이미지 ID(AMI ID)가 다르므로, 최신 Amazon Linux 2023의 ID를 조회하여 변수에 담거나 복사합니다.

```bash
# Amazon Linux 2023의 최신 AMI ID 조회 명령
aws ec2 describe-images \
    --owners amazon \
    --filters "Name=name,Values=al2023-ami-2023.*-x86_64" \
    --query "sort_by(Images, &CreationDate)[-1].ImageId" \
    --output text

```

* **출력 예시:** `ami-0c9c942bd7bf113a2` (이 값을 아래 실행 명령에 사용합니다.)

---

### 6. 인스턴스 시작 (Run Instances)

위에서 준비한 모든 정보를 조합하여 인스턴스를 생성합니다.

**[공통 명령어 구조]**

* `--image-id`: 위에서 조회한 AMI ID
* `--security-group-ids`: 2.1에서 생성한 보안 그룹 ID
* `--key-name`: 3번에서 생성한 키 이름 (`my-cli-key`)
* `--user-data`: 4번 스크립트 파일 경로 (`file://` 접두사 필수)

**[Linux / Mac 실행 명령]**

```bash
aws ec2 run-instances \
    --image-id ami-xxxxxx \
    --count 1 \
    --instance-type t2.micro \
    --key-name my-cli-key \
    --security-group-ids sg-xxxxxx \
    --user-data file://user_data.sh \
    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=Web-Server-CLI}]'

```

**[Windows PowerShell 실행 명령]**
(줄바꿈 문자가 ```임에 유의)

```powershell
aws ec2 run-instances `
    --image-id ami-xxxxxx `
    --count 1 `
    --instance-type t2.micro `
    --key-name my-cli-key `
    --security-group-ids sg-xxxxxx `
    --user-data file://user_data.sh `
    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=Web-Server-CLI}]'

```

---

### 7. 생성 확인 및 접속 테스트

인스턴스가 생성되면 퍼블릭 IP를 확인하고 웹 브라우저로 접속합니다.

#### 7.1 인스턴스 상태 및 IP 확인

```bash
aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=Web-Server-CLI" \
    --query "Reservations[*].Instances[*].{Instance:InstanceId, IP:PublicIpAddress, State:State.Name}" \
    --output table

```

#### 7.2 접속 테스트

1. 위 명령에서 출력된 **Public IP**를 복사합니다.
2. 웹 브라우저 주소창에 `http://[Public IP]` 입력.
3. **"Hello! AWS CLI Web Server"** 문구가 보이면 성공입니다.

---

### 8. 리소스 정리 (삭제)

실습이 끝나면 반드시 리소스를 삭제하여 과금을 방지합니다.

```bash
# 1. 인스턴스 종료 (ID 입력)
aws ec2 terminate-instances --instance-ids i-[인스턴스ID]

# 2. 보안 그룹 삭제 (인스턴스가 완전히 종료된 후 실행 가능)
aws ec2 delete-security-group --group-id sg-[보안그룹ID]

# 3. 키 페어 삭제
aws ec2 delete-key-pair --key-name my-cli-key

```

Next Step: 생성한 EC2 인스턴스에 SSH 클라이언트(터미널)로 직접 접속하는 방법 (Windows/Mac)
