

# Ubuntu Postfix & Dovecot 메일 서버 구축

## 1. 개요

리눅스 환경에서 자체 메일 서버를 구축하기 위해서는 크게 두 가지 핵심 소프트웨어가 필요하다.

1. **MTA (Mail Transfer Agent):** 메일을 전송하고 수신하는 우체국 역할. 리눅스에서는 **Postfix**가 표준으로 사용된다. (SMTP 프로토콜 사용)
2. **MDA (Mail Delivery Agent):** 수신된 메일을 우편함에 저장하고, 사용자가 이메일 클라이언트(Outlook, Thunderbird)를 통해 가져갈 수 있게 해주는 역할. **Dovecot**이 주로 사용된다. (POP3/IMAP 프로토콜 사용)

이 장에서는 Ubuntu Server 환경에서 Postfix와 Dovecot을 연동하여 기본 메일 서버를 구축하는 과정을 다룬다.

---

## 2. 사전 준비: DNS 레코드 설정

메일 서버가 정상적으로 작동하려면 DNS 설정이 선행되어야 한다. 도메인 구입처나 DNS 관리 콘솔(Route53 등)에서 다음 레코드를 등록한다.

* **A 레코드:** `mail.example.com` -> `서버_IP_주소`
* **MX 레코드:** `example.com` -> `mail.example.com` (우선순위 10)

> **Cloud Warning (AWS EC2 사용자 필독):**
> AWS, Azure, GCP 등 대부분의 클라우드 사업자는 스팸 메일 발송을 막기 위해 **25번 포트(Outbound)를 기본적으로 차단**한다.
> * **수신:** 문제없음.
> * **발송:** 외부로 메일이 나가지 않음. 이를 해결하려면 AWS 측에 '이메일 전송 제한 해제 요청'을 하거나, Amazon SES 같은 릴레이 서비스를 사용해야 한다.
> 
> 

---

## 3. Postfix 설치 및 설정 (SMTP)

### 3.1 설치

설치 과정에서 구성 유형을 묻는 화면이 나오면 다음과 같이 선택한다.

1. **General type of mail configuration:** `Internet Site` 선택.
2. **System mail name:** 도메인 이름 입력 (예: `example.com`).

```bash
sudo apt update
sudo apt install postfix -y

```

### 3.2 설정 파일 수정 (`/etc/postfix/main.cf`)

Postfix의 핵심 설정 파일을 편집한다.

```bash
sudo nano /etc/postfix/main.cf

```

**주요 수정 및 추가 항목:**

```ini
# 호스트 이름 설정
myhostname = mail.example.com

# 도메인 설정
mydomain = example.com
myorigin = /etc/mailname

# 메일 수신 허용 범위 (all로 설정해야 외부 메일 수신 가능)
inet_interfaces = all

# 메일 저장 방식 (Maildir 포맷 사용 - Dovecot 호환성 위함)
# 기본값인 mbox 대신 폴더 방식인 Maildir을 강제 설정
home_mailbox = Maildir/

# 신뢰하는 네트워크 대역 (내부망 + 로컬호스트)
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128

```

### 3.3 서비스 재시작

```bash
sudo systemctl restart postfix

```

---

## 4. Dovecot 설치 및 설정 (IMAP/POP3)

### 4.1 설치

Dovecot 코어와 IMAP, POP3 데몬을 설치한다.

```bash
sudo apt install dovecot-core dovecot-imapd dovecot-pop3d -y

```

### 4.2 메일 저장소 설정 (`10-mail.conf`)

Postfix에서 설정한 `Maildir/` 경로와 일치시켜야 한다.

```bash
sudo nano /etc/dovecot/conf.d/10-mail.conf

```

**수정 내용:**

```ini
# (기존 설정을 주석 처리하거나 변경)
mail_location = maildir:~/Maildir

```

### 4.3 인증 설정 (`10-auth.conf`)

초기 테스트를 위해 평문(Plaintext) 인증을 허용한다. (보안을 위해 추후 SSL 적용 시 변경 필요)

```bash
sudo nano /etc/dovecot/conf.d/10-auth.conf

```

**수정 내용:**

```ini
disable_plaintext_auth = no
auth_mechanisms = plain login

```

### 4.4 마스터 설정 (`10-master.conf`)

Postfix가 Dovecot의 인증 시스템을 사용할 수 있도록 소켓 권한을 수정한다.

```bash
sudo nano /etc/dovecot/conf.d/10-master.conf

```

**수정 내용 (주석 해제 및 수정):**

```ini
service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0668
    user = postfix
    group = postfix
  }
}

```

### 4.5 Postfix와 Dovecot 연동 설정

다시 Postfix 설정 파일(`main.cf`)로 돌아가서, Dovecot 인증을 사용하도록 설정을 추가한다.

```bash
sudo nano /etc/postfix/main.cf

```

**파일 맨 아래에 추가:**

```ini
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes

```

### 4.6 서비스 재시작

```bash
sudo systemctl restart postfix dovecot

```

---

## 5. 메일 계정 생성 및 테스트

리눅스 시스템 계정이 곧 메일 계정이 된다.

### 5.1 사용자 추가

```bash
# user1 계정 생성 (비밀번호 설정 필수)
sudo adduser user1

```

### 5.2 Telnet을 이용한 SMTP 발송 테스트 (로컬)

별도의 클라이언트 없이 터미널에서 메일 발송을 테스트한다.

```bash
telnet localhost 25

```

**SMTP 대화형 명령어 입력:**

```text
EHLO example.com
MAIL FROM: <user1@example.com>
RCPT TO: <user1@example.com>
DATA
Subject: Test Email
This is a test email from Postfix.
.
QUIT

```

* `250 2.0.0 Ok: queued as...` 메시지가 나오면 발송 성공이다.

### 5.3 수신 확인 (Maildir)

사용자 홈 디렉터리에 메일 파일이 생성되었는지 확인한다.

```bash
sudo ls -R /home/user1/Maildir/new/

```

파일이 존재하면 메일이 정상적으로 도착하여 저장된 것이다.

---

## 6. 방화벽 및 포트 구성

외부에서 메일을 주고받으려면 다음 포트를 방화벽(UFW 및 AWS Security Group)에서 열어야 한다.

| 프로토콜 | 포트 | 용도 |
| --- | --- | --- |
| **SMTP** | 25 | 다른 메일 서버간 통신 (수신) |
| **IMAP** | 143 | 메일 수신 (클라이언트 연결) |
| **POP3** | 110 | 메일 수신 (클라이언트 연결 - 다운로드 방식) |
| **SMTP** | 587 | 메일 클라이언트 발송용 (Submission) |

```bash
sudo ufw allow 25/tcp
sudo ufw allow 143/tcp
sudo ufw allow 110/tcp
sudo ufw allow 587/tcp

```

---

Next Step: 메일 서버 보안 강화 (SSL/TLS 인증서 적용) 및 스팸 방지 기술(SPF, DKIM) 설정
