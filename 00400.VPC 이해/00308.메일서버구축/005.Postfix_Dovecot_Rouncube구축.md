온프레미스 환경의 Ubuntu 서버에서 메일 서버를 구축하는 과정은 복잡하지만, 가장 표준적인 조합인 **Postfix**(송신), **Dovecot**(수신), **Roundcube**(웹메일)를 이용한 구축 실습 전 과정을 정리합니다.

---

## 1. 사전 준비 사항 (Prerequisites)

메일 서버는 보안과 스팸 방지 정책이 매우 까다롭기 때문에 아래 조건이 충족되어야 합니다.

* **OS:** Ubuntu 22.04 또는 24.04 LTS
* **고정 IP:** 외부와 통신 가능한 공인 IP (고정 IP 권장)
* **도메인:** 메일 주소로 사용할 도메인 (예: `example.com`)
* **DNS 설정:**
* **A 레코드:** `mail.example.com` -> 서버 IP
* **MX 레코드:** `example.com` -> `mail.example.com` (우선순위 10)
* **PTR 레코드 (역방향 DNS):** ISP에 요청하여 IP를 도메인으로 매핑 (스팸 차단 방지 필수)



---

## 2. 서버 기본 설정

서버의 호스트 이름을 메일 서버용 FQDN(Full Qualified Domain Name)으로 변경합니다.

```bash
# 호스트네임 설정
$ sudo hostnamectl set-hostname mail.example.com

# /etc/hosts 수정
127.0.0.1 localhost
211.104.16.5  mail.example.com mail  #공인 ip

$ hostname -f
mail.example.com #성공

```

---

## 3. Postfix 설치 및 설정 (SMTP - 메일 송신)

### 설치

```bash
sudo apt update
sudo apt install postfix -y

```

설정 창이 뜨면 **'Internet Site'**를 선택하고, System mail name에 `example.com`을 입력합니다.

### 설정 수정 (`/etc/postfix/main.cf`)

```bash
sudo postconf -e "myhostname = mail.example.com"
sudo postconf -e "mydestination = \$myhostname, example.com, localhost.localdomain, localhost"
sudo postconf -e "mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128"
sudo postconf -e "home_mailbox = Maildir/"

```

* **Maildir/**: 메일을 파일 단위로 관리하는 최신 방식입니다.

---

## 4. Dovecot 설치 및 설정 (POP3/IMAP - 메일 수신)

### 설치

```bash
sudo apt install dovecot-imapd dovecot-pop3d -y

```

### 메일박스 경로 설정 (`/etc/dovecot/conf.d/10-mail.conf`)

```conf
mail_location = maildir:~/Maildir

```

### 인증 설정 (`/etc/dovecot/conf.d/10-auth.conf`)

```conf
disable_plaintext_auth = no
auth_mechanisms = plain login

```

---

## 5. Roundcube 웹메일 설치 (Webmail UI)

사용자가 브라우저에서 메일을 확인하기 위한 GUI 환경입니다.

### DB 및 웹서버 설치

```bash
sudo apt install apache2 mariadb-server php php-mysql roundcube -y

```

* **과금 주의:** 온프레미스 구축은 하드웨어 비용 외에 소프트웨어 라이선스 비용은 없으나, 외부 DNS 대행사나 도메인 유지비가 발생할 수 있습니다.

---

## 6. 방화벽 설정 (UFW)

메일 통신에 필요한 포트를 반드시 열어주어야 합니다.

| 포트 번호 | 서비스 | 용도 |
| --- | --- | --- |
| **25** | SMTP | 서버 간 메일 전송 (가장 중요) |
| **143 / 993** | IMAP / IMAPS | 메일 읽기 |
| **587** | Submission | 사용자 메일 발송 |
| **80 / 443** | HTTP / HTTPS | 웹메일 접속 |

```bash
sudo ufw allow 25,587,143,993,80,443/tcp

```

---

## 7. 스팸 방지 및 보안 설정 (고급)

단순 설치만으로는 Gmail이나 네이버로 메일을 보낼 수 없습니다. 아래 DNS 레코드를 반드시 추가해야 합니다.

1. **SPF (Sender Policy Framework):** 내 도메인에서 메일을 보낼 수 있는 IP를 지정.
* TXT 레코드: `v=spf1 ip4:서버IP -all`


2. **DKIM (DomainKeys Identified Mail):** 메일에 디지털 서명을 추가하여 변조 방지.
3. **DMARC:** SPF/DKIM 실패 시 처리 정책 설정.

---

## 8. 실습 종료 후 자원 정리

온프레미스는 클라우드처럼 삭제 시 비용이 멈추는 개념은 아니지만, 보안을 위해 다음을 수행합니다.

* 사용하지 않는 포트 차단 (`ufw delete allow 25`)
* 메일 릴레이(Open Relay) 상태가 되지 않도록 Postfix 서비스 중지 (`sudo systemctl stop postfix`)

Next Step: SPF, DKIM, DMARC 레코드 설정 및 메일 수신 신뢰도 테스트 방법

---


Next Step:온프레미스 환경의 Ubuntu 서버에서 메일 서버를 구축하는 과정은 복잡하지만, 가장 표준적인 조합인 **Postfix**(송신), **Dovecot**(수신), **Roundcube**(웹메일)를 이용한 구축 실습 전 과정을 정리합니다.

---

## 1. 사전 준비 사항 (Prerequisites)

메일 서버는 보안과 스팸 방지 정책이 매우 까다롭기 때문에 아래 조건이 충족되어야 합니다.

* **OS:** Ubuntu 22.04 또는 24.04 LTS
* **고정 IP:** 외부와 통신 가능한 공인 IP (고정 IP 권장)
* **도메인:** 메일 주소로 사용할 도메인 (예: `example.com`)
* **DNS 설정:**
* **A 레코드:** `mail.example.com` -> 서버 IP
* **MX 레코드:** `example.com` -> `mail.example.com` (우선순위 10)
* **PTR 레코드 (역방향 DNS):** ISP에 요청하여 IP를 도메인으로 매핑 (스팸 차단 방지 필수)



---

## 2. 서버 기본 설정

서버의 호스트 이름을 메일 서버용 FQDN(Full Qualified Domain Name)으로 변경합니다.

```bash
# 호스트네임 설정
sudo hostnamectl set-hostname mail.example.com

# /etc/hosts 수정
# 127.0.0.1 localhost
# IP주소 mail.example.com mail

```

---

## 3. Postfix 설치 및 설정 (SMTP - 메일 송신)

### 설치

```bash
sudo apt update
sudo apt install postfix -y

```

설정 창이 뜨면 **'Internet Site'**를 선택하고, System mail name에 `example.com`을 입력합니다.

### 설정 수정 (`/etc/postfix/main.cf`)

```bash
sudo postconf -e "myhostname = mail.example.com"
sudo postconf -e "mydestination = \$myhostname, example.com, localhost.localdomain, localhost"
sudo postconf -e "mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128"
sudo postconf -e "home_mailbox = Maildir/"

```

* **Maildir/**: 메일을 파일 단위로 관리하는 최신 방식입니다.

---

## 4. Dovecot 설치 및 설정 (POP3/IMAP - 메일 수신)

### 설치

```bash
sudo apt install dovecot-imapd dovecot-pop3d -y

```

### 메일박스 경로 설정 (`/etc/dovecot/conf.d/10-mail.conf`)

```conf
mail_location = maildir:~/Maildir

```

### 인증 설정 (`/etc/dovecot/conf.d/10-auth.conf`)

```conf
disable_plaintext_auth = no
auth_mechanisms = plain login

```

---

## 5. Roundcube 웹메일 설치 (Webmail UI)

사용자가 브라우저에서 메일을 확인하기 위한 GUI 환경입니다.

### DB 및 웹서버 설치

```bash
sudo apt install apache2 mariadb-server php php-mysql roundcube -y

```

* **과금 주의:** 온프레미스 구축은 하드웨어 비용 외에 소프트웨어 라이선스 비용은 없으나, 외부 DNS 대행사나 도메인 유지비가 발생할 수 있습니다.

---

## 6. 방화벽 설정 (UFW)

메일 통신에 필요한 포트를 반드시 열어주어야 합니다.

| 포트 번호 | 서비스 | 용도 |
| --- | --- | --- |
| **25** | SMTP | 서버 간 메일 전송 (가장 중요) |
| **143 / 993** | IMAP / IMAPS | 메일 읽기 |
| **587** | Submission | 사용자 메일 발송 |
| **80 / 443** | HTTP / HTTPS | 웹메일 접속 |

```bash
sudo ufw allow 25,587,143,993,80,443/tcp

```

---

## 7. 스팸 방지 및 보안 설정 (고급)

단순 설치만으로는 Gmail이나 네이버로 메일을 보낼 수 없습니다. 아래 DNS 레코드를 반드시 추가해야 합니다.

1. **SPF (Sender Policy Framework):** 내 도메인에서 메일을 보낼 수 있는 IP를 지정.
* TXT 레코드: `v=spf1 ip4:서버IP -all`


2. **DKIM (DomainKeys Identified Mail):** 메일에 디지털 서명을 추가하여 변조 방지.
3. **DMARC:** SPF/DKIM 실패 시 처리 정책 설정.

---

## 8. 실습 종료 후 자원 정리

온프레미스는 클라우드처럼 삭제 시 비용이 멈추는 개념은 아니지만, 보안을 위해 다음을 수행합니다.

* 사용하지 않는 포트 차단 (`ufw delete allow 25`)
* 메일 릴레이(Open Relay) 상태가 되지 않도록 Postfix 서비스 중지 (`sudo systemctl stop postfix`)

Next Step: SPF, DKIM, DMARC 레코드 설정 및 메일 수신 신뢰도 테스트 방법

---

설정하신 규칙에 따라 깃허브 마크다운 포맷으로 작성하였으며, 온프레미스 환경이지만 도메인 및 DNS 유지 등 발생 가능한 비용 요소를 언급했습니다.

Next Step: DNS 보안 레코드 설정
