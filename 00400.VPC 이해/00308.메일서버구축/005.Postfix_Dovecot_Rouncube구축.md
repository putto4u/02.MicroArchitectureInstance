온프레미스 환경의 Ubuntu 서버에서 메일 서버를 구축하는 과정은 복잡하지만, 가장 표준적인 조합인 **Postfix**(송신), **Dovecot**(수신), **Roundcube**(웹메일)를 이용한 구축 실습 전 과정을 정리합니다.

---

## 1. 사전 준비 사항 (Prerequisites)

메일 서버는 보안과 스팸 방지 정책이 매우 까다롭기 때문에 아래 조건이 충족되어야 합니다.

* **OS:** Ubuntu 22.04 또는 24.04 LTS
* **고정 IP:** 외부와 통신 가능한 공인 IP (고정 IP 권장)
* **도메인:** 메일 주소로 사용할 도메인 (예: `example.com`)
* **DNS 설정:**
* **A 레코드:** `mail.example.com` -> 서버 IP
* **MX 레코드:** `example.com` -> `mail.example.com` (우선순위 10)
* **PTR 레코드 (역방향 DNS):** ISP에 요청하여 IP를 도메인으로 매핑 (스팸 차단 방지 필수)



---

## 2. 서버 기본 설정

서버의 호스트 이름을 메일 서버용 FQDN(Full Qualified Domain Name)으로 변경합니다.

```bash
# 호스트네임 설정
$ sudo hostnamectl set-hostname mail.example.com

# /etc/hosts 수정
127.0.0.1 localhost
211.104.16.5  mail.example.com mail  #공인 ip

$ hostname -f
mail.example.com #성공

```

---

## 3. Postfix 설치 및 설정 (SMTP - 메일 송신)

### 설치

```bash
sudo apt update
sudo apt install postfix -y

```

설정 창이 뜨면 **'Internet Site'**를 선택하고, System mail name에 `example.com`을 입력합니다.

### 설정 수정 (`/etc/postfix/main.cf`)

```bash
sudo postconf -e "myhostname = mail.example.com"
sudo postconf -e "mydestination = \$myhostname, example.com, localhost.localdomain, localhost"
sudo postconf -e "mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128"
sudo postconf -e "home_mailbox = Maildir/"

```

* **Maildir/**: 메일을 파일 단위로 관리하는 최신 방식입니다.

---

## 4. Dovecot 설치 및 설정 (POP3/IMAP - 메일 수신)

### 설치

```bash
sudo apt install dovecot-imapd dovecot-pop3d -y

```

### 메일박스 경로 설정 (`/etc/dovecot/conf.d/10-mail.conf`)

```conf
mail_location = maildir:~/Maildir

```

### 인증 설정 (`/etc/dovecot/conf.d/10-auth.conf`)

```conf
disable_plaintext_auth = no
auth_mechanisms = plain login

```

---

## 5. Roundcube 웹메일 설치 (Webmail UI)

사용자가 브라우저에서 메일을 확인하기 위한 GUI 환경입니다.

### DB 및 웹서버 설치

```bash
sudo apt install apache2 mariadb-server php php-mysql roundcube -y

```

* **과금 주의:** 온프레미스 구축은 하드웨어 비용 외에 소프트웨어 라이선스 비용은 없으나, 외부 DNS 대행사나 도메인 유지비가 발생할 수 있습니다.

---

## 6. 방화벽 설정 (UFW)

메일 통신에 필요한 포트를 반드시 열어주어야 합니다.

| 포트 번호 | 서비스 | 용도 |
| --- | --- | --- |
| **25** | SMTP | 서버 간 메일 전송 (가장 중요) |
| **143 / 993** | IMAP / IMAPS | 메일 읽기 |
| **587** | Submission | 사용자 메일 발송 |
| **80 / 443** | HTTP / HTTPS | 웹메일 접속 |

```bash
sudo ufw allow 25,587,143,993,80,443/tcp

```

---

## 7. 스팸 방지 및 보안 설정 (고급)

단순 설치만으로는 Gmail이나 네이버로 메일을 보낼 수 없습니다. 아래 DNS 레코드를 반드시 추가해야 합니다.

1. **SPF (Sender Policy Framework):** 내 도메인에서 메일을 보낼 수 있는 IP를 지정.
* TXT 레코드: `v=spf1 ip4:서버IP -all`


2. **DKIM (DomainKeys Identified Mail):** 메일에 디지털 서명을 추가하여 변조 방지.
3. **DMARC:** SPF/DKIM 실패 시 처리 정책 설정.

---

## 8. 실습 종료 후 자원 정리

온프레미스는 클라우드처럼 삭제 시 비용이 멈추는 개념은 아니지만, 보안을 위해 다음을 수행합니다.

* 사용하지 않는 포트 차단 (`ufw delete allow 25`)
* 메일 릴레이(Open Relay) 상태가 되지 않도록 Postfix 서비스 중지 (`sudo systemctl stop postfix`)

Next Step: SPF, DKIM, DMARC 레코드 설정 및 메일 수신 신뢰도 테스트 방법

---
메일 서버의 엔진(Postfix, Dovecot) 설치와 기본 설정이 완료되었다면, 실제로 메일이 내부와 외부로 정상적으로 오가는지 확인하는 **메일 송수신 테스트** 단계를 진행해야 합니다.

이 과정에서는 시스템 계정을 생성하고, 터미널 명령어를 통해 메일을 보내본 뒤, 웹메일(Roundcube)을 통해 수신 여부를 확인합니다.

---

## 9. 메일 송수신 실습 (테스트 계정 활용)

### 9-1. 테스트용 OS 사용자 생성

메일 서버는 기본적으로 리눅스 시스템 계정을 메일 계정으로 사용합니다. 테스트를 위해 두 개의 계정을 생성합니다.

```bash
# user01과 user02 계정 생성 (비밀번호 설정 포함)
sudo adduser user01
sudo adduser user02

```

### 9-2. 메일 송신 테스트 (Terminal)

`mailutils` 패키지를 설치하여 터미널에서 `user01`이 `user02`에게 메일을 보내봅니다.

```bash
# 메일 발송 도구 설치
sudo apt install mailutils -y

# user01 계정으로 메일 발송 시뮬레이션
echo "안녕하세요. 메일 서버 테스트 메시지입니다." | mail -s "테스트 메일 제목" user02@example.com

```

### 9-3. 메일 수신 확인 (Roundcube)

이제 브라우저를 통해 웹메일 화면에 접속하여 메일이 도착했는지 확인합니다.

1. **접속 주소:** `http://서버IP/roundcube` 또는 `http://mail.example.com/roundcube`
2. **로그인:** * 사용자: `user02`
* 비밀번호: (계정 생성 시 설정한 암호)


3. **확인:** 받은 편지함에 `user01`이 보낸 메일이 있는지 확인합니다.

---

## 10. 외부 메일 발송 테스트 및 트러블슈팅

내부 통신이 성공했다면, 외부(Gmail, Naver 등)로 메일을 발송해 봅니다. 단, 이 단계에서는 앞서 언급한 **SPF/DKIM/PTR** 설정이 안 되어 있다면 스팸 처리되거나 반송될 수 있습니다.

### 10-1. 로그 모니터링

메일 발송 시 문제가 발생하면 반드시 로그를 확인해야 합니다. 터미널 창을 하나 더 열어 아래 명령어를 실행한 상태로 테스트하세요.

```bash
# 실시간 메일 로그 확인
sudo tail -f /var/log/mail.log

```

### 10-2. 주요 체크포인트

* **Connection Timeout:** ISP(통신사)나 클라우드 보안 그룹에서 **25번 포트**를 차단하고 있을 가능성이 매우 높습니다.
* **Relay Access Denied:** `/etc/postfix/main.cf`의 `mynetworks` 설정에 발신자 대역이 포함되지 않은 경우입니다.
* **Service Unavailable:** Postfix나 Dovecot 서비스가 작동 중인지 확인하세요. (`sudo systemctl status postfix`)

---

## 11. 실습 비용 및 환경 정리

* **도메인 결제:** 실습을 위해 도메인을 구매했다면 연간 유지비(약 1~2만 원)가 발생합니다.
* **AWS 환경 과금:** * **Elastic IP (EIP):** 할당 시 시간당 **$0.005**가 부과됩니다.
* **Data Transfer:** 외부로 메일을 대량 발송할 경우 데이터 전송료가 발생할 수 있습니다.


* **자원 회수:** 실습이 끝났다면 반드시 생성한 인스턴스를 종료(Terminate)하고 EIP를 릴리스(Release)하여 불필요한 과금을 방지하세요.

Next Step: 외부 메일 수신 신뢰도를 높이기 위한 PTR 레코드 등록 및 25번 포트 해제 요청 실무

---

설정하신 지침에 따라 깃허브 마크다운 형식을 준수하였으며, 챕터 번호를 이어가며 실제 커맨드 위주의 실습 과정을 구성했습니다. 또한 AWS IPv4 과금 관련 정보를 포함하였습니다.

Next Step: 외부 신뢰도 확보 실무
