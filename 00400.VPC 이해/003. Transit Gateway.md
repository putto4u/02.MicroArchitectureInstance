AWS **Transit Gateway(TGW)**는 수많은 VPC와 온프레미스 네트워크를 중앙에서 단일 지점을 통해 연결해 주는 클라우드 라우터 서비스입니다. VPC 피어링이 늘어남에 따라 발생하는 그물망(Mesh) 구조의 복잡성을 해결하기 위해 도입되었습니다.

---

## Transit Gateway의 핵심 개념

### 1. 허브 앤 스포크(Hub and Spoke) 구조

VPC 피어링이 1:1 연결 방식이라면, Transit Gateway는 중앙 허브 역할을 합니다. 새로운 VPC를 추가할 때 다른 모든 VPC와 개별적으로 피어링을 맺을 필요 없이, 중앙의 Transit Gateway에만 연결(Attachment)하면 됩니다.

### 2. 전이적 루팅(Transitive Routing) 지원

VPC 피어링의 최대 단점이었던 '전이적 통신 불가' 문제를 해결합니다. Transit Gateway에 연결된 모든 VPC는 중앙 라우터를 통해 서로 통신할 수 있어 네트워크 구조가 매우 단순해집니다.

### 3. 주요 구성 요소

* **Attachments**: VPC, VPN, 또는 Direct Connect를 Transit Gateway에 연결하는 지점입니다.
* **Transit Gateway Route Tables**: 각 연결에서 들어오는 패킷을 어디로 보낼지 결정하는 중앙 라우팅 테이블입니다. 하나 이상의 라우팅 테이블을 만들어 트래픽 흐름을 세밀하게 제어할 수 있습니다.
* **Associations/Propagations**: 특정 연결을 라우팅 테이블에 결합하고, 경로 정보를 자동으로 전파하는 기능입니다.

---

## Transit Gateway vs VPC 피어링 비교

| 구분 | VPC Peering | Transit Gateway |
| --- | --- | --- |
| **구조** | 1:1 매시(Mesh) 구조 | 중앙 집중형 (Hub & Spoke) |
| **복잡도** | 연결 수가 많아질수록 관리 어려움 | 중앙에서 통합 관리 가능 |
| **전이적 루팅** | 지원 안 함 | **지원 함** |
| **최대 연결** | VPC당 125개 (기본 50개) | 수천 개의 연결 지원 |
| **비용** | 낮은 편 (데이터 전송료만 발생) | 높은 편 (시간당 비용 + 데이터 처리비) |

---

## 실무 사례: 3개의 VPC 연결

* **VPC A (개발)**: `10.1.0.0/16`
* **VPC B (스테이징)**: `10.2.0.0/16`
* **VPC C (운영)**: `10.3.0.0/16`

1. **TGW 생성**: `tgw-01` 생성
2. **Attachment**: VPC A, B, C를 각각 `tgw-01`에 연결
3. **라우팅 설정**:
* VPC A의 라우팅 테이블에 `10.0.0.0/8` (전체 대역)의 타겟을 `tgw-01`로 지정
* VPC B, C도 동일하게 설정


4. **결과**: 별도의 추가 설정 없이 A, B, C는 서로 자유롭게 통신 가능 (보안 그룹에서 차단하지 않는 한)

---

## AWS Transit Gateway 과금 체계 (중요)

Transit Gateway는 편리한 만큼 VPC 피어링보다 비용 부담이 큽니다. 설계 시 예산 검토가 필수적입니다.

| 항목 | 과금 방식 (Seoul Region 기준) | 비고 |
| --- | --- | --- |
| **AWS Transit Gateway 배포** | 무료 | 생성 자체는 무료 |
| **TGW 연결(Attachment) 요금** | **$0.07 / 시간당 (연결당)** | VPC 3개 연결 시 시간당 약 $0.21 발생 |
| **데이터 처리 요금** | **$0.02 / GB** | TGW를 통과하는 데이터 양에 따라 부과 |
| **피어링 비용 (TGW 간)** | **$0.07 / 시간당 + 데이터 전송료** | 서로 다른 리전의 TGW를 연결할 경우 발생 |

> [!WARNING]
> **과금 주의**: VPC 10개를 TGW로 연결할 경우, 아무런 트래픽이 없어도 연결 비용만 월 약 $500(약 65만 원) 이상 발생할 수 있습니다. 소규모 네트워크에서는 VPC 피어링이 경제적입니다.

---

AWS Transit Gateway(TGW)를 중심으로 국내 VPC 3개(A, B, C)와 해외 지사(Global Branch)를 연결하고, 인터넷 통신까지 지원하는 중앙 집중형 네트워크 설계 사례를 정리합니다.

---

## 1. 네트워크 설계 환경 (IP 레이아웃)

| 구분 | 용도 | CIDR 블록 | 가용 영역(AZ) |
| --- | --- | --- | --- |
| **VPC A** | 국내 개발망 | `10.1.0.0/16` | ap-northeast-2a/c |
| **VPC B** | 국내 스테이징망 | `10.2.0.0/16` | ap-northeast-2a/c |
| **VPC C** | 국내 공유 서비스망 | `10.3.0.0/16` | ap-northeast-2a/c |
| **VPC Shared** | **공용 인터넷 출구** | `10.10.0.0/16` | ap-northeast-2a/c |
| **해외 지사** | 싱가포르 지사 | `172.16.0.0/12` | (TGW Peering 연결) |

---

## 2. 라우팅 테이블(Routing Table) 설정 사례

TGW를 통해 인터넷으로 나가려면 **중앙 집중형 인터넷 게이트웨이(Centralized IGW)** 구조를 주로 사용합니다.

### ① 각 VPC(A, B, C) 내부 라우팅

모든 외부 트래픽(`0.0.0.0/0`)을 일단 TGW로 보냅니다.

| 대상 (Destination) | 타겟 (Target) | 비고 |
| --- | --- | --- |
| `10.x.0.0/16` | local | VPC 내부 통신 |
| **`0.0.0.0/0`** | **`tgw-01`** | **인터넷 및 타 VPC/해외지사 통신용** |

### ② Transit Gateway(TGW) 라우팅 테이블

TGW는 어떤 연결(Attachment)에서 패킷이 왔는지에 따라 다른 라우팅 테이블을 참조할 수 있습니다.

| 대상 (Destination) | 타겟 (Target) | 비고 |
| --- | --- | --- |
| `10.1.0.0/16` | Attachment-VPC-A | 국내 A망행 |
| `10.2.0.0/16` | Attachment-VPC-B | 국내 B망행 |
| `10.3.0.0/16` | Attachment-VPC-C | 국내 C망행 |
| **`172.16.0.0/12`** | **Attachment-TGW-Peering** | **싱가포르 해외 지사행** |
| **`0.0.0.0/0`** | **Attachment-VPC-Shared** | **인터넷 출구용 VPC로 전송** |

### ③ VPC Shared (인터넷 출구 전용) 라우팅

TGW에서 올라온 트래픽을 실제 NAT Gateway나 IGW로 던져주는 역할을 합니다.

| 대상 (Destination) | 타겟 (Target) | 비고 |
| --- | --- | --- |
| `10.0.0.0/8` | `tgw-01` | 모든 국내 VPC행 트래픽 리턴 |
| `172.16.0.0/12` | `tgw-01` | 해외 지사행 트래픽 리턴 |
| **`0.0.0.0/0`** | **`nat-01` 또는 `igw-01**` | **최종 인터넷 출구** |

---

## 3. 보안 그룹(SG) 및 NACL 설정 사례

VPC A에 있는 서버(`10.1.1.10`)가 VPC C의 공유 DB(`10.3.1.50`)에 접속하는 상황을 가정합니다.

### ① 보안 그룹 (Security Group - Stateful)

인스턴스 단위의 방화벽입니다.

* **VPC C의 DB 보안 그룹 (인바운드 규칙)**:
* 프로토콜: TCP (3306)
* 소스: **`10.1.0.0/16`** (VPC A 전체 대역 허용) 또는 **`10.1.1.10/32`** (특정 서버 허용)



### ② NACL (Network ACL - Stateless)

서브넷 단위의 방화벽이며, **나가는 패킷(Outbound)과 들어오는 패킷(Inbound)을 모두 명시**해야 합니다.

* **VPC A의 NACL**:
  
| 규칙 번호 | 유형 | 프로토콜 | 포트 범위 | 소스/대상 | 허용/거부 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 인바운드 100 | 임시 포트 | TCP | 1024-65535 | `0.0.0.0/0` | 허용 |
| 아웃바운드 100 | HTTP/S | TCP | 80/443 | `0.0.0.0/0` | 허용 (인터넷행) |
| 아웃바운드 200 | DB 접속 | TCP | 3306 | `10.3.1.50/32` | 허용 (VPC C행) |

---

## 4. 과금 및 유료 전환 주의 사항

Transit Gateway 운영 시 비용은 '연결(Attachment)'과 '데이터 처리'에서 주로 발생합니다.

* **Attachment 비용**: 위 시나리오에서는 VPC 4개(A, B, C, Shared) + 해외지사 피어링 1개 = 총 5개의 연결이 있습니다.
* **월 고정비**: $0.07 * 5개 * 24시간 * 30일 = **약 $252 (약 33만 원)**


* **데이터 처리비**: TGW를 통과하는 모든 데이터에 대해 **GB당 $0.02**가 부과됩니다. 인터넷으로 나가는 트래픽은 TGW를 두 번(VPC A -> TGW, TGW -> VPC Shared) 거칠 수 있으므로 설계에 따라 데이터 비용이 중복 발생할 수 있습니다.
* **해외 지사 피어링**: 리전 간 피어링 데이터 전송료(Inter-Region Data Transfer)는 일반 전송료보다 비싸므로 대규모 데이터 동기화 시 주의가 필요합니다.

---


## 1. VPC A (국내 개발망) NACL 설정 

VPC A(`10.1.0.0/16`)의 서브넷에 적용되는 규칙입니다.

### 인바운드 규칙 (Inbound Rules)

| 규칙 번호 | 유형 | 프로토콜 | 포트 범위 | 소스(Source) | 허용/거부 | 비고 |
| --- | --- | --- | --- | --- | --- | --- |
| 100 | HTTP | TCP | 80 | `0.0.0.0/0` | ALLOW | 외부 통신 허용 |
| 110 | HTTPS | TCP | 443 | `0.0.0.0/0` | ALLOW | 외부 통신 허용 |
| 200 | Custom TCP | TCP | 1024-65535 | `0.0.0.0/0` | ALLOW | **응답용 임시 포트(필수)** |
| * | All Traffic | ALL | ALL | `0.0.0.0/0` | DENY | 기본 차단 |

### 아웃바운드 규칙 (Outbound Rules)

| 규칙 번호 | 유형 | 프로토콜 | 포트 범위 | 대상(Destination) | 허용/거부 | 비고 |
| --- | --- | --- | --- | --- | --- | --- |
| 100 | Custom TCP | TCP | 3306 | `10.3.1.50/32` | ALLOW | VPC C의 DB로 접속 |
| 200 | HTTP | TCP | 80 | `0.0.0.0/0` | ALLOW | 인터넷 요청 송신 |
| 210 | HTTPS | TCP | 443 | `0.0.0.0/0` | ALLOW | 인터넷 요청 송신 |
| 300 | Custom TCP | TCP | 1024-65535 | `0.0.0.0/0` | ALLOW | 외부 요청에 대한 응답 |
| * | All Traffic | ALL | ALL | `0.0.0.0/0` | DENY | 기본 차단 |

---

## 2. VPC C (공유 서비스망) NACL 설정 사례

공유 DB 서버(`10.3.1.50`)가 위치한 서브넷에 적용됩니다.

### 인바운드 규칙 (Inbound Rules)

| 규칙 번호 | 유형 | 프로토콜 | 포트 범위 | 소스(Source) | 허용/거부 | 비고 |
| --- | --- | --- | --- | --- | --- | --- |
| 100 | MySQL/Aurora | TCP | 3306 | `10.1.0.0/16` | ALLOW | VPC A로부터의 DB 접속 허용 |
| 110 | MySQL/Aurora | TCP | 3306 | `172.16.0.0/12` | ALLOW | 해외 지사로부터의 DB 접속 허용 |
| * | All Traffic | ALL | ALL | `0.0.0.0/0` | DENY | 기본 차단 |

### 아웃바운드 규칙 (Outbound Rules)

| 규칙 번호 | 유형 | 프로토콜 | 포트 범위 | 대상(Destination) | 허용/거부 | 비고 |
| --- | --- | --- | --- | --- | --- | --- |
| 100 | Custom TCP | TCP | 1024-65535 | `10.1.0.0/16` | ALLOW | VPC A 요청에 대한 응답 |
| 110 | Custom TCP | TCP | 1024-65535 | `172.16.0.0/12` | ALLOW | 해외 지사 요청에 대한 응답 |
| * | All Traffic | ALL | ALL | `0.0.0.0/0` | DENY | 기본 차단 |

---

## 💡 설정 시 핵심 주의 사항

1. **임시 포트(Ephemeral Ports)**: 클라이언트가 서버에 접속한 후 응답을 받을 때 사용하는 포트입니다. OS마다 다르지만, AWS 서비스 간 통신 시에는 일반적으로 **1024-65535** 범위를 모두 열어주는 것이 안전합니다.
2. **Stateless 특성**: 보안 그룹(SG)과 달리 NACL은 나가는 문이 열려있어도 들어오는 문이 닫혀있으면 통신이 실패합니다. 반드시 양방향 규칙을 세트로 생각하세요.
3. **규칙 번호 순서**: 번호가 낮은 규칙이 우선순위가 높습니다. 구체적인 IP를 허용하는 규칙을 앞번호(예: 100)에 두고, 넓은 범위나 차단 규칙을 뒷번호(예: 900)에 배치하십시오.

---
Transit Gateway(TGW)의 가장 큰 장점은 **라우팅 테이블 격리(Segmentation)**를 통해 복잡한 네트워크 환경에서도 보안 경계를 명확히 설정할 수 있다는 점입니다. 이를 통해 특정 부서나 환경(개발, 운영, 공유 서비스 등) 간의 통신을 물리적 분리 없이도 완벽하게 제어할 수 있습니다.

---

## 1. TGW 격리 설계의 핵심 메커니즘

TGW는 일반적인 라우터와 달리 **연관(Association)**과 **전파(Propagation)**라는 두 가지 개념을 분리하여 사용합니다.

* **연관 (Association)**: 특정 연결(VPC 등)에서 TGW로 들어오는 패킷이 **참조할 라우팅 테이블**을 지정합니다. (연결당 1개만 가능)
* **전파 (Propagation)**: 특정 연결의 IP 대역 정보를 **어떤 라우팅 테이블에 등록할 것인지** 결정합니다. (여러 테이블에 전파 가능)

---

## 2. 보안 격리 모델 사례 (Isolate vs Shared)

앞서 다룬 VPC A(개발), B(스테이징), C(공유) 사례에 **격리 보안 정책**을 적용해 보겠습니다.

* **정책**: VPC A와 B는 서로 통신할 수 없으며, 오직 공통 서비스인 VPC C와만 통신할 수 있다.

### ① TGW 라우팅 테이블 구성

| 테이블 명 | 연관(Association) 대상 | 전파(Propagation) 대상 | 비고 |
| --- | --- | --- | --- |
| **Isolated RT** | VPC A, VPC B | **VPC C**, 해외 지사 | A, B는 서로의 경로를 모르게 됨 |
| **Shared RT** | VPC C, 해외 지사 | **VPC A, VPC B, VPC C** | C는 모든 곳으로 응답 가능 |

### ② 상세 트래픽 흐름

1. **VPC A → VPC B**: VPC A가 참조하는 `Isolated RT`에는 VPC B의 경로가 없으므로 통신이 불가능합니다. (보안 격리 성공)
2. **VPC A → VPC C**: `Isolated RT`에 VPC C가 전파되어 있으므로 통신이 가능합니다.
3. **VPC C → VPC A**: VPC C가 참조하는 `Shared RT`에는 VPC A의 경로가 있으므로 응답이 가능합니다.

---

## 3. 심층 방어: 보안 검사(Inspection) 아키텍처

보안을 더욱 강화하기 위해 모든 VPC 간 트래픽이나 인터넷 트래픽을 **중앙 방화벽(Firewall)**을 거치게 설계할 수 있습니다.

* **Inspection VPC**: 팔로알토, 포티넷 등 서드파티 방화벽이나 AWS Network Firewall이 위치하는 전용 VPC입니다.
* **설계 방식**:
* VPC A에서 나가는 모든 트래픽(`0.0.0.0/0`)의 타겟을 TGW로 잡습니다.
* TGW는 해당 트래픽을 **Inspection VPC**로 보냅니다.
* 방화벽 검사가 끝난 트래픽만 다시 TGW를 통해 목적지(VPC B 또는 인터넷)로 전달됩니다.



---

## 4. TGW 보안 설계 시 과금 및 성능 주의 사항

격리 구조가 복잡해질수록 관리 효율은 높아지지만 비용과 성능에 영향을 줄 수 있습니다.

| 항목 | 상세 내용 | 과금/영향도 |
| --- | --- | --- |
| **멀티 라우팅 테이블** | 테이블 개수 자체에는 비용이 들지 않음 | 관리 복잡도 증가 |
| **Appliance Mode** | Inspection VPC 사용 시 AZ 간 대칭 라우팅을 위해 필수 활성화 | 설정 오기입 시 통신 단절 가능 |
| **데이터 처리비** | **$0.02 / GB** | Inspection VPC를 거칠 경우 TGW를 두 번 통과하게 되어 처리비가 **2배** 발생할 수 있음 |
| **대역폭** | 연결당 최대 **50Gbps** (폭주 시 성능 저하 주의) | 대규모 데이터 이동 시 모니터링 필수 |

---

Next Step: Transit Gateway Appliance Mode와 대칭 라우팅 설정법


